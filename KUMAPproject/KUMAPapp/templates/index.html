<html>
{% load static %}
<head>
	<meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<title>ğŸ¯KUMAPğŸ¯</title>
    <link rel="stylesheet" type="text/css" href="{% static './MapApp/css/base.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static './css/search.css' %}" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="static/MapApp/css/index.css">
</head>
<body>
  
    <div id="mapwrap" class="middle">
      <div class="wrapper hidden" id="search_modal_1">
            <div class="searchBox">
                <div class="header">
                    <h2>ëª©ì ì§€ ê²€ìƒ‰</h2>
                    <input onkeyup="filter()" type="text" id="value" placeholder="ëª©ì ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.">
                </div>
                <div class="choice">
                    {% for building in buildingList %}
                    <div class="item" onclick="hiddenToggle1('{{building.pk}}','{{building.building_lat}}','{{building.building_lon}}','{{building.building_name}}')">
                        <span id="select_building" class="name" style="cursor:pointer;"> {{building.building_name}} </span>
                    </div>
                    {% endfor %}
                </div>   
            </div>
          </div>
        <div class="wrapper hidden" id="search_modal_2">
            <div class="searchBox">
                <div class="header">
                    <h2>ëª©ì ì§€ ê²€ìƒ‰</h2>
                    <input onkeyup="filter()" type="text" id="value" placeholder="ëª©ì ì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.">
                </div>
                <div class="choice">
                    {% for building in buildingList %}
                    <div class="item" onclick="hiddenToggle('{{building.building_name}}')">
                        <span id="select_building" class="name" style="cursor:pointer;"> {{building.building_name}} </span>
                    </div>
                    {% endfor %}
                </div>   
            </div>
          </div>
        <div id="map" style="width:100%;height:100vh;">
            <div class="first_search_modal">
              <span class="material-icons search_scope">search</span>
              <span class="search_font">ëª©ì ì§€ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</span>
            </div>
            <div class="scroll__wrap">
                <div class="scroll--element" id="cafeMenu"><div>ì¹´í˜</div></div>
                <div class="scroll--element" id="resMenu"><div>ì‹ë‹¹</div></div>
                <div class="scroll--element" id="loungeMenu"><div>ë¼ìš´ì§€</div></div>
                <div class="scroll--element" id="bookMenu"><div>ì±…ë°˜ë‚©ê¸°</div></div>
                <div class="scroll--element" id="printMenu"><div>í”„ë¦°í„°</div></div>
                <div class="scroll--element" id="allMenu"><div>ëª¨ë“  ê±´ë¬¼</div></div>
            </div>
        </div>
        <div class="modal"></div>
    </div>
    <!-- ì§€ë„ ìœ„ì— í‘œì‹œë  ë§ˆì»¤ ì¹´í…Œê³ ë¦¬ -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=	19de326d13f32aab18ce3a0096074178"></script>
	<script type="text/javascript">
		/* ì§€ë„ ìƒì„± */
		var mapContainer = document.getElementById('map');
		var mapOption = {
			center: new kakao.maps.LatLng(37.58631, 127.02936),
			level: 4
		}
		var map = new kakao.maps.Map(mapContainer, mapOption);

		/* DB ì •ë³´ ì €ì¥ */
		const buildings = {{ buildings|safe }};
		const temp1 = JSON.stringify(buildings);
    const temp2 = JSON.parse(temp1)
	
		/* Building ì¤‘ì‹¬ >> ìœ„ë„, ê²½ë„ ì¢Œí‘œ ì €ì¥ */
		const buildingLocations  = temp2.map(element => {return  {
			    pk: element.pk,
        	latlng: new kakao.maps.LatLng(element.fields.building_lat, element.fields.building_lon),
          lat: element.fields.building_lat,
          long: element.fields.building_lon,
		      history: element.fields.history,
        }} );

        // ëª¨ë“  ê±´ë¬¼ ë§ˆì»¤ë“¤ì˜ ì¢Œí‘¯ê°’ ë‹´ì•„ë‘ê¸°
        let allPositions = []
        buildingLocations.forEach(function(item){
            allPositions.push(item['latlng'])
            var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 
            var imageSize = new kakao.maps.Size(24, 35); 
            
            // ë§ˆì»¤ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤    
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 
            
            // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            var marker = new kakao.maps.Marker({
                map: map, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ì§€ë„
                position: item.latlng, // ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìœ„ì¹˜
                image : markerImage // ë§ˆì»¤ ì´ë¯¸ì§€ 
            });
            kakao.maps.event.addListener(marker, 'click', function(mouseEvent) { 
            var latlng = item.latlng;
            console.log(latlng)
            console.log('!!!!!')
            location.href = `javascript:display(${item.pk}); setZoomRange(${latlng.getLat()}, ${latlng.getLng()});`;
            })
        })
        function makeSearchmodalGetName(name){
          let searchboxname = document.querySelector('.search_font')
          searchboxname.innerText = name
        }
        function hiddenToggle1(pk,lat,lon,name){
          let big_Modal_1 = document.getElementById('search_modal_1')
          makeSearchmodalGetName(name)
          const clickedClass = "hidden";
          if (big_Modal_1.classList.contains(clickedClass)) {
            big_Modal_1.classList.remove(clickedClass);
          } else {
            big_Modal_1.classList.add(clickedClass);
          }
          const buildingLocation = {
            pk: pk,
            latlng: new kakao.maps.LatLng(lat,lon),
          }
          var latlng = buildingLocation.latlng
          setZoomRange(latlng.getLat(), latlng.getLng())
          display(pk);
        }

        for (var i = 0; i < allPositions.length; i ++) {
    
            // ë§ˆì»¤ ì´ë¯¸ì§€ì˜ ì´ë¯¸ì§€ í¬ê¸° ì…ë‹ˆë‹¤
        }    
        function showSecondModal(name){
        template=`
        <div class="container">
          <img src="{% static './images/close_button.png' %}" class="closeButton" onclick="closeModal()">
          <h3>ì´ë™ê²½ë¡œ ê²€ìƒ‰</h3>
          <p class="address" style="margin-top:0px;">ë„ë³´ ê¸°ì¤€ ì´ë™ê²½ë¡œ ë° ì‹œê°„ì„ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
          <div class="bar"></div>
          <div class="button_loc search_btn" style="cursor:pointer;">
            <img src="{% static './images/location.png' %}" class="locationImage">
            <span id="from_building">ì¶œë°œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!</span>
          </div>
          <div class="button_loc">
            <img src="{% static './images/location.png' %}" class="locationImage">
            <span>ëª©ì ì§€ : ${name}</span>
          </div>
          <a class="button_main">ì´ë™ê²½ë¡œ ê²€ìƒ‰</a>
        </div>`
        modal = document.querySelector(".modal")
        modal.innerHTML = template
        btn_loc()
      }
      
      function grab_etr(){
        var etr_btn = document.querySelector('.etrance_btn')
        
        etr_btn.addEventListener('click',()=>{
          str_str_btn = String(etr_btn.id)
          var result3 = str_str_btn.slice(9);
          
          window.location.href=`http://localhost:8000/entrance/${result3}`
        })
      }
      function grab_fac(){
        var etr_btn = document.querySelector('.facility_btn')
        etr_btn.addEventListener('click',()=>{
          str_str_btn = String(etr_btn.id)
          var result3 = str_str_btn.slice(9);
          window.location.href=`http://localhost:8000/facility/${result3}`
        })
      }
      function showFirstModal(schoolPk){
            if (schoolPk != null){
            $.ajax({
            url: "detail_ajax/"+schoolPk,
            async: false,
            type: "GET",
            dataType: "json",
            success: (data) => {
                const num=data.pk
                template = 
                `<div class="container">
                    <img src="{% static './images/close_button.png' %}" class="closeButton" onclick="closeModal()">
                    <h3>` + data.name + `</h3>
                    <p class="address" style="margin-top:0px;"></p>
                    <div class="bar"></div>
                    <a class="button_main" onclick="showSecondModal('` +data.name +`')">ëª©ì ì§€ ì„¤ì •</a>
                    <p id="entrance_${data.pk}" class="button_else etrance_btn">ê±´ë¬¼ ì¶œì…êµ¬ í™•ì¸í•˜ê¸°</p>
                    <p id="facility_${data.pk}" class="button_else facility_btn">ê±´ë¬¼ ë‚´ ì‹œì„¤ í™•ì¸í•˜ê¸°</p>
                </div>`               
                },
                error: (error) => {
                console.log(error);
                }
            });
            modal = document.querySelector(".modal")
            modal.innerHTML = template
            grab_etr()
            grab_fac()
            }
        }
        function display(pk) {
          showFirstModal(pk);
        }
        function closeModal(){
        template=''
        modal = document.querySelector(".modal")
        makeSearchmodalGetName('ëª©ì ì§€ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”')
        modal.innerHTML = template
      }
        let MarkerStorage = []
        /* category ë²„íŠ¼ í´ë¦­ ì‹œ ë°›ì•„ì˜¤ëŠ” ë§ˆì»¤ ì¢Œí‘œê°’ ë¹„ë™ê¸° êµ¬í˜„ */
    
        const changeCategory = (kind) => {
          console.log('í•¨ìˆ˜ ì‹¤í–‰ í›„ ---')
          console.log(MarkerStorage)
          MarkerStorage.forEach(function(item){
            item.setMap(null)
          })
          //ì„±ìš´//
        
          if (kind == 1){
            imageSrc = "https://postfiles.pstatic.net/MjAyMjA4MDRfMTY1/MDAxNjU5NTQ1MzY1OTk3.FPkKlKkdyWb9MZ278pBlrNymusH_CGWPshTggNTzY10g.vt3gYVAhITm4Lk_md5yh74wWRQJrEn-qkKpUeBnoRl0g.PNG.ahrefhoo/coffeMarker.png?type=w966";
          }
          else if (kind == 2){
            imageSrc = "https://postfiles.pstatic.net/MjAyMjA4MTNfMTEy/MDAxNjYwMzk5MTQyNDQy.IDdyImo1zXyCsyWUm6APqWP9BZGVmERzn-ajSHhveisg.0qb2Ht5rnRpM5UFu8L7qoZNSzErSpwvniG8BhGsJz2og.PNG.ahrefhoo/resMarker.png?type=w966";
          }
          else if (kind == 3){
            imageSrc = "https://postfiles.pstatic.net/MjAyMjA4MDRfMjQ1/MDAxNjU5NTQ1MzcxNDMy.Lmu4a7UAs9HmLVpjkKs133pfmV4NJWCvUFclvQYBEQsg.JCT58_NY-6l69dompsgYZxHnGMRXPrWstDcGAaaLnTMg.PNG.ahrefhoo/sofaMarker.png?type=w966";
          }
          else if (kind == 4){
            imageSrc = "https://postfiles.pstatic.net/MjAyMjA4MDRfMTE3/MDAxNjU5NTQ1MzYxNTQy.EUDoV7kVj6e48lsbZl8L08UZtMbm-GKvjpJWltKCCcYg.U2EjflUTJRhFkuAutKOFWvRoV1IgWQ8STeGe6w2gkhYg.PNG.ahrefhoo/bookMarker.png?type=w966";
          }
          else if (kind == 5){
            imageSrc = "https://postfiles.pstatic.net/MjAyMjA4MTNfNDYg/MDAxNjYwMzk5MTQyNDU2.INEx4gxaxKfFUG8faigcHbCK_25YMR_tPY1M-c-KAjAg.XExP0IFFQaHj-SdNCRXsTrwpTfzpwiXbgAwm8OZTZAYg.PNG.ahrefhoo/printMarker.png?type=w966";
          }
          // ì´ --- ì´ // 
          console.log('ì¹´í…Œê³ ë¦¬ í•¨ìˆ˜ê°€ ì œëŒ€ë¡œ ì‘ë™ë˜ì—ˆì–´ìš”')
          fetch('/category/' + kind, {
            method: "POST",
          })
          .then(response => response.json())
          .then(res => res['latlng'].forEach(function(item){
            var imageSize = new kakao.maps.Size(24, 35);
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);
          
            var marker = new kakao.maps.Marker({
              map: map,
              position: new kakao.maps.LatLng(item[0], item[1]),
              image: markerImage
            })
            MarkerStorage.push(marker)
          }))
        }   
        console.log(MarkerStorage)
        
        function DeleteMarkers(m_array) {
          m_array.forEach(function(item){
            item.setMap(null)
          })
        }

        let cafebtn = document.getElementById('cafeMenu');
        cafebtn.addEventListener('click', ()=>{
          console.log('ì¹´í˜ê°€ ì œëŒ€ë¡œ í´ë¦­ë˜ì—ˆì–´ìš”')
          changeCategory(1)
        })
      

        let resbtn = document.getElementById('resMenu')
        resbtn.addEventListener('click', ()=>{
          console.log('ì‹ë‹¹ì´ ì œëŒ€ë¡œ í´ë¦­ë˜ì—ˆì–´ìš”')
          changeCategory(2)
        })

        let loungebtn = document.getElementById('loungeMenu')
        loungebtn.addEventListener('click', ()=>{
          console.log('ë¼ìš´ì§€ê°€ ì œëŒ€ë¡œ í´ë¦­ë˜ì—ˆì–´ìš”')
          changeCategory(3)
        })

        let bookbtn = document.getElementById('bookMenu')
        bookbtn.addEventListener('click', ()=>{
          console.log('ì±… ë°˜ë‚©ê¸°ê°€ ì œëŒ€ë¡œ í´ë¦­ë˜ì—ˆì–´ìš”')
          changeCategory(4)
        })

        let printerbtn = document.getElementById('printMenu')
        printerbtn.addEventListener('click', ()=>{
          console.log('í”„ë¦°í„°ê°€ ì œëŒ€ë¡œ í´ë¦­ë˜ì—ˆì–´ìš”')
          changeCategory(5)
        })

        let allbtn = document.getElementById('allMenu')
        allbtn.addEventListener('click', ()=>{
          console.log('ëª¨ë“  ê±´ë¬¼ì´ ì œëŒ€ë¡œ í´ë¦­ë˜ì—ˆì–´ìš”')
          changeCategory(6)
        })

        function setZoomRange(lat, lng) {
          var moveLatLon = new kakao.maps.LatLng(lat, lng);
          map.panTo(moveLatLon);
        
      }    
        
        
      function btn_loc(){
        let searching=document.querySelector('.search_btn')
        searching.addEventListener('click',()=>{
          hiddenToggle('a')
        })
      }
      function filter(){
        
                var value, name, item, i;
        
                value = document.getElementById("value").value.toUpperCase();
                item = document.getElementsByClassName("item");
        
                for(i=0;i<item.length;i++){
                  name = item[i].getElementsByClassName("name");
                  if(name[0].innerHTML.toUpperCase().indexOf(value) > -1){
                    item[i].style.display = "flex";
                  }else{
                    item[i].style.display = "none";
                  }
                }
              }
      let big_modal_2 = document.getElementById('search_modal_2')
      let finding_btn = document.querySelector('.first_search_modal')
      finding_btn.addEventListener('click',()=>{
        document.getElementById('search_modal_1').classList.toggle('hidden')
      })
      function hiddenToggle(name){
        let big_Modal_2 = document.getElementById('search_modal_2')
        document.getElementById('from_building').innerHTML=`ì¶œë°œì§€ : ${name}`
        const clickedClass = "hidden";
        if (big_Modal_2.classList.contains(clickedClass)) {
          big_Modal_2.classList.remove(clickedClass);
        } else {
          big_Modal_2.classList.add(clickedClass);
        }
      }
      
    </script>
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2MXZH0045R');
    </script>
</body>
</html>
